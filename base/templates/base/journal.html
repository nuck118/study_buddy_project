{% extends 'base/main.html' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    
    <!-- HEADER -->
    <div class="mb-10 flex flex-col md:flex-row justify-between items-end gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fa-solid fa-timeline text-indigo-600 mr-2"></i>Study Timeline
            </h1>
            <p class="text-gray-500 mt-1">Track your daily learning progress in realtime.</p>
        </div>
        <button onclick="toggleForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all hover:-translate-y-0.5">
            <i class="fa-solid fa-plus mr-2"></i> Log Activity
        </button>
    </div>

    <!-- ENTRY FORM -->
    <div id="entryForm" class="hidden bg-white p-8 rounded-2xl shadow-xl border border-gray-100 mb-12 transform transition-all relative z-20">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Add New Entry</h2>
            <button onclick="toggleForm()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
        </div>
        
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Activity Title</label>
                <input type="text" name="title" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Date</label>
                    <input type="date" name="date" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Start Time</label>
                    <input type="time" name="start_time" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">End Time</label>
                    <input type="time" name="end_time" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Notes</label>
                <textarea name="description" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" required></textarea>
            </div>
            <div class="p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 text-center relative cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition">
                <input type="file" name="image" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <p class="text-gray-500 text-sm"><i class="fa-solid fa-image mr-2"></i>Upload Image (Optional)</p>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-md transition-all">Save to Timeline</button>
        </form>
    </div>

    <!-- VERTICAL TIMELINE -->
    <div class="relative">
        <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200"></div>

        {% regroup entries by date as date_list %}

        {% for date_group in date_list %}
            
            <!-- DATE BADGE -->
            <div class="relative pl-24 py-6">
                <div class="absolute left-0 w-16 h-16 bg-white border-4 border-indigo-100 rounded-full flex flex-col items-center justify-center shadow-sm z-10 text-center">
                    <span class="text-xs font-bold text-gray-400 uppercase">{{ date_group.grouper|date:"M" }}</span>
                    <span class="text-xl font-bold text-indigo-600 leading-none">{{ date_group.grouper|date:"d" }}</span>
                </div>
                <h2 class="text-lg font-bold text-gray-500 uppercase tracking-wide h-16 flex items-center">{{ date_group.grouper|date:"l, Y" }}</h2>
            </div>

            <!-- ENTRY CARDS -->
            {% for entry in date_group.list %}
            <div class="relative pl-24 pb-8 group journal-entry"
                 data-date="{{ entry.date|date:'Y-m-d' }}"
                 data-start="{{ entry.start_time|time:'H:i' }}"
                 data-end="{{ entry.end_time|time:'H:i' }}">
                
                <div class="absolute left-[1.85rem] top-6 w-3 h-3 bg-gray-300 rounded-full border-2 border-white ring-2 ring-transparent group-hover:bg-indigo-500 group-hover:ring-indigo-100 transition-all z-10"></div>
                <div class="absolute left-[2.2rem] top-[1.65rem] w-16 h-[2px] bg-gray-100 group-hover:bg-indigo-50 transition-colors"></div>

                <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 hover:shadow-lg transition-all relative overflow-hidden">
                    
                    <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-2 mb-3 pl-2">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 group-hover:text-indigo-600 transition-colors">{{ entry.title }}</h3>
                            <div class="flex items-center gap-2 text-xs font-bold text-gray-400 mt-1 uppercase tracking-wider">
                                <i class="fa-regular fa-clock"></i>
                                {{ entry.start_time|time:"H:i" }} - {{ entry.end_time|time:"H:i" }}
                            </div>
                        </div>
                        <div>
                            <a href="{% url 'edit_journal' entry.id %}" class="text-gray-300 hover:text-indigo-600 transition-colors p-2"><i class="fa-solid fa-pen-to-square text-lg"></i></a>
                        </div>
                    </div>

                    <!-- REALTIME PROGRESS BAR -->
                    <div class="mb-4 pl-2 pr-2">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs font-bold text-indigo-600 status-text">Scheduled</span>
                            <span class="text-xs font-bold text-gray-400 percent-text">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div class="bg-indigo-500 h-2 rounded-full progress-bar transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>

                    <p class="text-gray-600 pl-2 mb-4 text-sm leading-relaxed">{{ entry.description }}</p>

                    <!-- --- RESPONSIVE IMAGE DISPLAY --- -->
                    {% if entry.image %}
                    <div class="pl-2 mt-4">
                        <div class="relative group/image overflow-hidden rounded-xl border border-gray-100 shadow-sm cursor-zoom-in"
                             onclick="openImageModal('{{ entry.image.url }}')">
                            
                            <!-- Responsive Height Classes: h-48 (mobile) -> h-64 (tablet) -> h-80 (desktop) -->
                            <img src="{{ entry.image.url }}" 
                                 class="w-full h-48 md:h-64 lg:h-80 object-cover transition-transform duration-700 group-hover/image:scale-105" 
                                 alt="Journal Entry Image">
                            
                            <!-- Overlay Hint -->
                            <div class="absolute inset-0 bg-black/0 group-hover/image:bg-black/20 transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-expand text-white opacity-0 group-hover/image:opacity-100 transition-opacity text-3xl drop-shadow-md"></i>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>
            {% endfor %}

        {% empty %}
            <div class="relative pl-24 py-10">
                <div class="bg-gray-50 rounded-xl p-8 border border-dashed border-gray-300 text-center">
                    <p class="text-gray-500">Timeline is empty.</p>
                </div>
            </div>
        {% endfor %}
        
        <div class="absolute left-[1.85rem] bottom-0 w-3 h-3 bg-gray-200 rounded-full"></div>
    </div>
</div>

<!-- --- IMAGE VIEWER MODAL --- -->
<div id="imageModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm transition-opacity" onclick="closeImageModal()">
    <!-- Close Button -->
    <button class="absolute top-5 right-5 text-white/70 hover:text-white bg-gray-800/50 hover:bg-red-600 rounded-full w-12 h-12 flex items-center justify-center transition">
        <i class="fa-solid fa-times text-xl"></i>
    </button>
    
    <!-- Full Image -->
    <img id="fullImage" src="" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain transform transition-transform" onclick="event.stopPropagation()">
</div>

<!-- JAVASCRIPT -->
<script>
    function toggleForm() {
        document.getElementById('entryForm').classList.toggle('hidden');
    }

    // --- MODAL LOGIC ---
    function openImageModal(url) {
        const modal = document.getElementById('imageModal');
        const img = document.getElementById('fullImage');
        img.src = url;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Restore scrolling
    }

    // --- PROGRESS LOGIC ---
    function updateProgress() {
        const now = new Date();
        const entries = document.querySelectorAll('.journal-entry');

        entries.forEach(entry => {
            const dateStr = entry.getAttribute('data-date');
            const startStr = entry.getAttribute('data-start');
            const endStr = entry.getAttribute('data-end');

            const startTime = new Date(`${dateStr}T${startStr}:00`);
            const endTime = new Date(`${dateStr}T${endStr}:00`);
            
            const progressBar = entry.querySelector('.progress-bar');
            const statusText = entry.querySelector('.status-text');
            const percentText = entry.querySelector('.percent-text');

            let percentage = 0;
            let status = "";

            if (now < startTime) {
                percentage = 0;
                status = "Upcoming";
                statusText.className = "text-xs font-bold text-gray-400 status-text";
                progressBar.classList.remove('bg-green-500', 'bg-indigo-500');
                progressBar.classList.add('bg-gray-300');
            } else if (now >= startTime && now <= endTime) {
                const totalDuration = endTime - startTime;
                const elapsed = now - startTime;
                percentage = Math.floor((elapsed / totalDuration) * 100);
                status = "In Progress";
                statusText.className = "text-xs font-bold text-indigo-600 status-text animate-pulse";
                progressBar.classList.remove('bg-gray-300', 'bg-green-500');
                progressBar.classList.add('bg-indigo-500');
            } else {
                percentage = 100;
                status = "Completed";
                statusText.className = "text-xs font-bold text-green-600 status-text";
                progressBar.classList.remove('bg-gray-300', 'bg-indigo-500');
                progressBar.classList.add('bg-green-500');
            }

            progressBar.style.width = `${percentage}%`;
            statusText.innerText = status;
            percentText.innerText = `${percentage}%`;
        });
    }

    updateProgress();
    setInterval(updateProgress, 10000);
</script>
{% endblock %}